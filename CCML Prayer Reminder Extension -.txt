# CCML Prayer Reminder Extension - Update TODO List

## Phase 1: Analysis & Cleanup

### Bugs to Fix
1. **Duplicate extraction calls** in `content-script.js` - calls `extractAndSaveTimes()` 3 times immediately (lines 12-20)
2. **Hardcoded mosque URL** - `mawaqit.net/en/ccml` is hardcoded, won't work for other mosques
3. **Missing error handling** for geolocation
4. **Race condition** - multiple `setTimeout` calls can trigger overlapping extractions
5. **Offscreen document leak** - 3-minute timeout may not align with actual adhan length
6. **Fallback audio URL** uses external site that may be unreliable

### Redundant Code to Remove
1. **`content-script.js`** - entire file becomes redundant once using Mawaqit API properly (it scrapes CCML website, not needed if using Mawaqit)
2. **`test-extraction-script.js`** - development/debug file, remove from production
3. **Default prayer times function** `getDefaultPrayerTimes()` - less useful once proper fetching works
4. **Duplicate manifest host permission** - `https://www.ccmgl.ch/*` not needed if only using Mawaqit

---

## Phase 2: Implementation TODO

### Step 1: Add Generic Adhan Audio
- [ ] Remove reference to local `adhan.mp3` in `manifest.json` web_accessible_resources
- [ ] Use a reliable CDN-hosted adhan or embed a small audio file as base64
- [ ] Update `offscreen.js` to use the generic source
- [ ] Remove fallback to `islamcan.com` (unreliable)

### Step 2: Implement Mosque Selection via Mawaqit
- [ ] Create new file `mosques.js` or add to popup - fetch mosque list from Mawaqit API
- [ ] Add mosque search/selection UI to `popup.html`
- [ ] Store selected mosque ID in `chrome.storage.local`
- [ ] Update `background.js` `fetchPrayerTimes()` to use dynamic mosque URL

### Step 3: Add Geolocation Support
- [ ] Add `"geolocation"` to manifest permissions (optional permission)
- [ ] Create geolocation request flow in popup
- [ ] Use Mawaqit's geo-search API: `https://mawaqit.net/api/2.0/mosque/search?lat=X&lon=Y`
- [ ] Show nearby mosques for user to select
- [ ] Handle permission denied gracefully

### Step 4: Update Popup UI
- [ ] Add "Select Mosque" section with search input
- [ ] Add "Use My Location" button
- [ ] Display currently selected mosque name
- [ ] Remove/simplify manual time entry (optional: keep as fallback)

### Step 5: Refactor Background Script
- [ ] Create `getMosqueUrl()` function using stored mosque ID
- [ ] Update fetch to use: `https://mawaqit.net/api/2.0/mosque/{uuid}/times`
- [ ] Parse JSON response instead of HTML scraping
- [ ] Add proper API error handling

### Step 6: Cleanup
- [ ] Delete `content-script.js`
- [ ] Delete `test-extraction-script.js`
- [ ] Remove content_scripts from `manifest.json`
- [ ] Remove `https://www.ccmgl.ch/*` from host_permissions
- [ ] Update README.md with new features

---

## Phase 3: File Changes Summary

| File | Action |
|------|--------|
| `manifest.json` | Update permissions, remove content_scripts, update description |
| `background.js` | Refactor fetch logic, use Mawaqit API, dynamic mosque |
| `popup.html` | Add mosque selection UI, geolocation button |
| `popup.js` | Add mosque search, geolocation, store preferences |
| `offscreen.js` | Use generic/embedded adhan audio |
| `content-script.js` | **DELETE** |
| `test-extraction-script.js` | **DELETE** |
| `README.md` | Update documentation |

---

## Implementation Order

1. Cleanup redundant files
2. Fix audio to use generic source
3. Implement Mawaqit API integration (JSON, not HTML scraping)
4. Add mosque storage/selection
5. Add geolocation + nearby mosque search
6. Update popup UI
7. Test all flows
8. Update documentation

Want me to start implementing these changes?